<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Call</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .hidden { display: none; }
        .video-container img {
            max-width: 100%;
            height: auto;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- First Page -->
    <div id="start-page" class="min-h-screen flex flex-col justify-center items-center">
        <div class="text-center bg-white p-8 rounded-lg shadow-md">
            <h1 class="text-3xl font-bold mb-6 text-gray-800">Welcome to the Video Call</h1>
            <button id="start-button" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded transition duration-300">
                Start Meeting
            </button>
        </div>
    </div>

    <!-- Second Page -->
    <div id="meeting-page" class="hidden min-h-screen flex flex-col">
        <div class="flex-grow container mx-auto p-4">
            <div class="video-container mb-4">
                <img src="http://localhost/video" class="w-full rounded-lg shadow-md" alt="Video Stream" />
            </div>
            
            <div class="controls flex justify-center space-x-4 mb-4">
                <button id="audio-button" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded transition duration-300">
                    Mute
                </button>
                <button id="chat-toggle-button" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded transition duration-300">
                    Chat
                </button>
                <button id="end-button" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded transition duration-300">
                    End Meeting
                </button>
            </div>

            <div id="chat-window" class="hidden bg-white rounded-lg shadow-md p-4">
                <div id="chat-messages" class="h-64 overflow-y-auto mb-4 border-b pb-2">
                    <!-- Chat messages will appear here -->
                </div>
                <div class="flex">
                    <input 
                        type="text" 
                        id="chat-input" 
                        placeholder="Type a message..." 
                        class="flex-grow mr-2 p-2 border rounded"
                    >
                    <button 
                        id="send-button" 
                        class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded transition duration-300"
                    >
                        Send
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Page Navigation
        const startPage = document.getElementById('start-page');
        const meetingPage = document.getElementById('meeting-page');
        const startButton = document.getElementById('start-button');

        // Meeting Controls
        const audioButton = document.getElementById('audio-button');
        const chatToggleButton = document.getElementById('chat-toggle-button');
        const endButton = document.getElementById('end-button');

        // Chat Elements
        const chatWindow = document.getElementById('chat-window');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');

        // WebSocket for signaling
        let socket;

        // Start Meeting
        startButton.addEventListener('click', () => {
            startPage.classList.add('hidden');
            meetingPage.classList.remove('hidden');
            initializeWebSocket();
        });

        // Audio Mute Toggle
        let isMuted = false;
        audioButton.addEventListener('click', () => {
            isMuted = !isMuted;
            audioButton.textContent = isMuted ? 'Unmute' : 'Mute';
            // TODO: Implement actual mute functionality
        });

        // Chat Toggle
        chatToggleButton.addEventListener('click', () => {
            chatWindow.classList.toggle('hidden');
        });

        // Send Message
        sendButton.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });

        function sendMessage() {
            const message = chatInput.value.trim();
            if (message) {
                // Add message to chat window
                const messageElement = document.createElement('div');
                messageElement.textContent = `You: ${message}`;
                messageElement.classList.add('p-2', 'bg-gray-100', 'rounded', 'mb-2');
                chatMessages.appendChild(messageElement);

                // Send via WebSocket if connected
                if (socket && socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({
                        type: 'chat',
                        message: message
                    }));
                }

                // Clear input
                chatInput.value = '';
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        // End Meeting
        endButton.addEventListener('click', () => {
            if (socket) socket.close();
            meetingPage.classList.add('hidden');
            startPage.classList.remove('hidden');
        });

        // Initialize WebSocket Connection
        function initializeWebSocket() {
            socket = new WebSocket('ws://localhost:8080/meeting');

            socket.onopen = () => {
                console.log('Connected to meeting server');
                // Send join meeting signal
                socket.send(JSON.stringify({
                    type: 'join',
                    timestamp: new Date().toISOString()
                }));
            };

            socket.onmessage = (event) => {
                const data = JSON.parse(event.data);
                
                switch(data.type) {
                    case 'chat':
                        const chatMsg = document.createElement('div');
                        chatMsg.textContent = `Participant: ${data.message}`;
                        chatMsg.classList.add('p-2', 'bg-blue-100', 'rounded', 'mb-2');
                        chatMessages.appendChild(chatMsg);
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                        break;
                    
                    case 'participant-update':
                        // Handle participant join/leave notifications
                        break;
                }
            };

            socket.onerror = (error) => {
                console.error('WebSocket Error:', error);
                alert('Connection error. Please try again.');
            };

            socket.onclose = () => {
                console.log('Disconnected from meeting server');
            };
        }
    </script>
</body>
</html>