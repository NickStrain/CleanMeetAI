<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CleanMeet AI</title>
  <style>
    /* Existing styles */
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: linear-gradient(135deg, #232121, #232121, #232121);
      color: #fff;
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 0 15px;
    }

    .header {
      width: 100%;
      padding: 20px;
      background: rgba(98, 93, 93, 0.9);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .header h1 {
      font-size: 2rem;
      font-weight: bold;
      margin: 0;
      letter-spacing: 2px;
    }

    .container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      align-items: start;
      width: 100%;
      max-width: 1200px;
      margin-top: 40px;
    }

    /* New Chat System Styles */
    .chat-container {
      background: rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 20px;
      height: 400px;
      display: flex;
      flex-direction: column;
      margin-top: 20px;
    }

    .chat-messages {
      flex-grow: 1;
      overflow-y: auto;
      padding: 10px;
      margin-bottom: 15px;
    }

    .message {
      margin: 8px 0;
      padding: 10px 15px;
      border-radius: 12px;
      max-width: 80%;
      word-wrap: break-word;
    }

    .message.sent {
      background: linear-gradient(90deg, #ff416c, #ff4b2b);
      margin-left: auto;
    }

    .message.received {
      background: rgba(255, 255, 255, 0.2);
      margin-right: auto;
    }

    .chat-input {
      display: flex;
      gap: 10px;
    }

    .chat-input input {
      flex-grow: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.2);
      color: #fff;
      font-size: 1rem;
    }

    .chat-input input::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }

    .chat-input button {
      padding: 12px 24px;
      font-size: 1rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      color: #fff;
      background: linear-gradient(90deg, #ff416c, #ff4b2b);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .chat-input button:hover {
      transform: scale(1.05);
      box-shadow: 0px 6px 15px rgba(255, 75, 43, 0.6);
    }

    /* Existing styles remain unchanged */
    /* ... */
  </style>
</head>
<body>
  <div class="header">
    <h1>CleanMeet AI</h1>
  </div>

  <div class="container">
    <!-- Video Section -->
    <div class="video-section">
      <video id="video" autoplay muted></video>
      <canvas id="canvas"></canvas>
      <div class="status-container">
        <div id="status" class="status">Waiting for detection...</div>
        <div id="status1" class="status">Waiting for detection...</div>
      </div>
    </div>

    <!-- Controls Section with Chat -->
    <div class="controls">
      <div class="button-container">
        <button id="startButton">Start Recording</button>
        <button id="stopButton" disabled>Stop Recording</button>
      </div>
      
      <!-- Chat System -->
      <div class="chat-container">
        <div class="chat-messages" id="chatMessages">
          <!-- Messages will be inserted here -->
        </div>
        <div class="chat-input">
          <input type="text" id="messageInput" placeholder="Type your message...">
          <button id="sendButton">Send</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Existing variables and functions remain...
    const video = document.getElementById("video");
    const canvas = document.getElementById("canvas");
    const statusDiv = document.getElementById("status");
    const status1Div = document.getElementById("status1");
    const startButton = document.getElementById("startButton");
    const stopButton = document.getElementById("stopButton");

    // New chat system variables
    const chatMessages = document.getElementById("chatMessages");
    const messageInput = document.getElementById("messageInput");
    const sendButton = document.getElementById("sendButton");

    let mediaRecorder;
    let audioChunks = [];
    let socket;
    let intervalId;

    // Initialize video and WebSocket stream
    async function startStream() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        video.srcObject = stream;

        // Create WebSocket connection to FastAPI backend
        socket = new WebSocket("ws://localhost:8000/wsaudio");
        

        socket.onopen = () => {
          console.log("WebSocket connected.");
          addMessage("System", "Connected to chat server", "received");
        };

        socket.onmessage = (event) => {
          console.log("Message received from server:", event.data);
          try {
            const data = JSON.parse(event.data);
            
            // Handle different types of messages
            if (data.type === "toxic") {
              status1Div.textContent = "⚠️ Offensive Audio Detected!";
              status1Div.className = "status negative";
            } else if (data.type === "chat") {
              addMessage("Other", data.message, "received");
            } else if (data.type === "nsfw") {
              statusDiv.textContent = "⚠️ NSFW Content Detected in Message!";
              statusDiv.className = "status negative";
            } else {
              status1Div.textContent = "✅ Audio is Safe";
              status1Div.className = "status positive";
            }
          } catch (err) {
            console.error("Error parsing WebSocket message:", err);
          }
        };

        socket.onclose = () => {
          console.log("WebSocket connection closed.");
          addMessage("System", "Disconnected from chat server", "received");
        };

        // Initialize media recorder for audio
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) {
            audioChunks.push(event.data);
          }
        };

        mediaRecorder.onstop = sendAudio;
        mediaRecorder.start();
        intervalId = setInterval(() => {
          mediaRecorder.stop();
          mediaRecorder.start();
        }, 5000);

        startButton.disabled = true;
        stopButton.disabled = false;
      } catch (err) {
        console.error("Error accessing media devices:", err);
      }
    }
    let chatSocket;

function initializeChatWebSocket() {
    chatSocket = new WebSocket("ws://localhost:8000/wschat");
    
    chatSocket.onopen = () => {
        console.log("Chat WebSocket connected");
        addMessage("System", "Connected to chat server", "received");
    };

    chatSocket.onmessage = (event) => {
        const data = JSON.parse(event.data);
        
        switch(data.type) {
            case "chat":
                addMessage("Other", data.message, "received");
                break;
            case "toxic":
                addMessage("System", data.message, "received");
                break;
            default:
                console.log("Unknown message type:", data.type);
        }
    };

    chatSocket.onclose = () => {
        console.log("Chat WebSocket disconnected");
        addMessage("System", "Disconnected from chat server", "received");
        // Attempt to reconnect after 5 seconds
        setTimeout(initializeChatWebSocket, 5000);
    };

    chatSocket.onerror = (error) => {
        console.error("WebSocket error:", error);
        addMessage("System", "Connection error occurred", "received");
    };
}

function sendMessage() {
    const messageInput = document.getElementById("messageInput");
    const message = messageInput.value.trim();
    
    if (message && chatSocket && chatSocket.readyState === WebSocket.OPEN) {
        const chatData = {
            type: "chat",
            message: message
        };
        
        chatSocket.send(JSON.stringify(chatData));
        addMessage("Me", message, "sent");
        messageInput.value = "";
    }
}

function addMessage(sender, message, type) {
    const chatMessages = document.getElementById("chatMessages");
    const messageElement = document.createElement("div");
    messageElement.className = `message ${type}`;
    messageElement.textContent = `${sender === "Me" ? "" : sender + ": "}${message}`;
    chatMessages.appendChild(messageElement);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Initialize WebSocket when page loads
document.addEventListener("DOMContentLoaded", () => {
    initializeChatWebSocket();
    
    // Add event listener for send button
    const sendButton = document.getElementById("sendButton");
    sendButton.addEventListener("click", sendMessage);
    
    // Add event listener for Enter key
    const messageInput = document.getElementById("messageInput");
    messageInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
            sendMessage();
        }
    });
});

    // // Add message to chat
    // function addMessage(sender, message, type) {
    //   const messageElement = document.createElement("div");
    //   messageElement.className = `message ${type}`;
    //   messageElement.textContent = `${sender === "Me" ? "" : sender + ": "}${message}`;
    //   chatMessages.appendChild(messageElement);
    //   chatMessages.scrollTop = chatMessages.scrollHeight;
    // }

    // // Send chat message
    // function sendMessage() {
    //   const message = messageInput.value.trim();
    //   if (message && socket && socket.readyState === WebSocket.OPEN) {
    //     const chatData = {
    //       type: "chat",
    //       message: message
    //     };
    //     socket.send(JSON.stringify(chatData));
    //     addMessage("Me", message, "sent");
    //     messageInput.value = "";
    //   }
    // }

    // Existing functions remain unchanged
    // ... (stopRecording, sendAudio, captureFrame, startDetection)

    // Event listeners
    startButton.addEventListener("click", startStream);
    stopButton.addEventListener("click", stopRecording);
    sendButton.addEventListener("click", sendMessage);
    messageInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") {
        sendMessage();
      }
    });

    // Initialize the detection
    startDetection();
  </script>
</body>
</html>